#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import ipaddress
import re
import sys

def extract_and_check_ips(text_block):
    """
    ãƒ†ã‚­ã‚¹ãƒˆãƒ–ãƒ­ãƒƒã‚¯ã‹ã‚‰å…¨ã¦ã®IP/CIDRå½¢å¼ã®æ–‡å­—åˆ—ã‚’æŠ½å‡ºã—ã€ç„¡åŠ¹ãªéƒ¨åˆ†ã‚’ç„¡è¦–ã—ã¦é‡è¤‡ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¾ã™ã€‚

    Args:
        text_block: IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å«ã‚€ä»»æ„ã®ãƒ†ã‚­ã‚¹ãƒˆãƒ–ãƒ­ãƒƒã‚¯ã€‚

    Returns:
        ã‚¿ãƒ—ãƒ« (overlapping_pairs, valid_networks, invalid_strings)
        - overlapping_pairs: é‡è¤‡ã—ã¦ã„ã‚‹IPã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ã‚¿ãƒ—ãƒ«ã®ãƒªã‚¹ãƒˆã€‚
        - valid_networks: æ­£å¸¸ã«è§£æã•ã‚ŒãŸIPã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ãƒªã‚¹ãƒˆã€‚
        - invalid_strings: IPã®ã‚ˆã†ã«è¦‹ãˆã‚‹ãŒæ¤œè¨¼ã«å¤±æ•—ã—ãŸæ–‡å­—åˆ—ã®ãƒªã‚¹ãƒˆã€‚
    """
    if not text_block:
        return ([], [], [])

    # 1. ã‚¤ãƒ³ãƒ†ãƒªã‚¸ã‚§ãƒ³ãƒˆæŠ½å‡ºï¼šæ­£è¦è¡¨ç¾ã‚’ä½¿ç”¨ã—ã¦ã€IP/CIDRå½¢å¼ã«ä¸€è‡´ã™ã‚‹å…¨ã¦ã®æ–‡å­—åˆ—ã‚’æ¤œç´¢ã—ã¾ã™ã€‚
    #    ã“ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã¯ xxx.xxx.xxx.xxx/xx ã®ã‚ˆã†ãªå½¢å¼ã‚’æ¤œå‡ºã—ã¾ã™ã€‚
    ip_pattern = r'\b\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}(?:\/\d{1,2})?\b'
    candidate_ips = re.findall(ip_pattern, text_block)

    valid_networks = []
    invalid_strings = []

    # 2. æŠ½å‡ºã•ã‚ŒãŸå„æ–‡å­—åˆ—ã‚’æ¤œè¨¼ã—ã¾ã™ã€‚
    for ip_str in candidate_ips:
        try:
            # æ–‡å­—åˆ—ã‚’æœ‰åŠ¹ãªIPãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›ã—ã‚ˆã†ã¨è©¦ã¿ã¾ã™ã€‚
            # strict=False ã¯ /31 ã®ã‚ˆã†ãªç‰¹æ®Šãªãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æŒ‡å®šã‚’è¨±å¯ã—ã¾ã™ã€‚
            network = ipaddress.ip_network(ip_str, strict=False)
            valid_networks.append(network)
        except ValueError:
            # å¤‰æ›ã«å¤±æ•—ã—ãŸå ´åˆï¼ˆä¾‹: 300.10.10.10ï¼‰ã€ç„¡åŠ¹ãªæ–‡å­—åˆ—ã¨ã—ã¦è¨˜éŒ²ã—ã¾ã™ã€‚
            invalid_strings.append(ip_str)

    # æœ‰åŠ¹ãªãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’ã‚½ãƒ¼ãƒˆã—ã¾ã™ã€‚
    valid_networks.sort()

    overlapping_pairs = []
    # æœ‰åŠ¹ãªãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯é–“ã§ã®ã¿é‡è¤‡ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¾ã™ã€‚
    if len(valid_networks) >= 2:
        for i in range(len(valid_networks)):
            for j in range(i + 1, len(valid_networks)):
                if valid_networks[i].overlaps(valid_networks[j]):
                    overlapping_pairs.append((valid_networks[i], valid_networks[j]))

    return (overlapping_pairs, valid_networks, invalid_strings)

def compare_ip_sets(networks1, networks2):
    """
    äºŒã¤ã®IPãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚»ãƒƒãƒˆã‚’æ¯”è¼ƒã—ã¦ã€ä¸€è‡´ãƒ»ä¸ä¸€è‡´ãƒ»è¿½åŠ ãƒ»å‰Šé™¤ã•ã‚ŒãŸé …ç›®ã‚’åˆ†æã—ã¾ã™ã€‚
    
    Args:
        networks1: æœ€åˆã®IPãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®ãƒªã‚¹ãƒˆ
        networks2: äºŒç•ªç›®ã®IPãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®ãƒªã‚¹ãƒˆ
    
    Returns:
        è¾æ›¸å½¢å¼ã®æ¯”è¼ƒçµæœ
    """
    set1 = set(networks1)
    set2 = set(networks2)
    
    common = set1 & set2  # å…±é€šã®IP
    only_in_first = set1 - set2  # æœ€åˆã®å…¥åŠ›ã«ã®ã¿å­˜åœ¨
    only_in_second = set2 - set1  # äºŒç•ªç›®ã®å…¥åŠ›ã«ã®ã¿å­˜åœ¨
    
    return {
        'identical': len(set1) == len(set2) and set1 == set2,
        'common': sorted(list(common)),
        'only_in_first': sorted(list(only_in_first)),
        'only_in_second': sorted(list(only_in_second)),
        'total_first': len(networks1),
        'total_second': len(networks2)
    }

def main():
    """
    ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã®å¯¾è©±ã‚’å®Ÿè¡Œã™ã‚‹ãƒ¡ã‚¤ãƒ³é–¢æ•°ã€‚
    """
    # æ—¥æœ¬èªãŒæ­£ã—ãè¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ã«æ¨™æº–å‡ºåŠ›ã®ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’è¨­å®šã—ã¾ã™ã€‚
    if sys.platform == "win32":
        sys.stdout.reconfigure(encoding='utf-8')
        sys.stdin.reconfigure(encoding='utf-8')

    print("=============================================")
    print("      IPã‚¢ãƒ‰ãƒ¬ã‚¹æŠ½å‡ºãƒ»é‡è¤‡ãƒ»æ¯”è¼ƒãƒã‚§ãƒƒã‚¯ãƒ„ãƒ¼ãƒ«")
    print("=============================================")
    print("ä½¿ã„æ–¹ï¼š")
    print("1. IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å«ã‚€ãƒ†ã‚­ã‚¹ãƒˆã‚’ãã®ã¾ã¾è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚")
    print("   (ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒè‡ªå‹•çš„ã«IP/CIDRã‚’æ¤œå‡ºã—ã€ä»–ã®å†…å®¹ã¯ç„¡è¦–ã—ã¾ã™)")
    print("2. è²¼ã‚Šä»˜ã‘å¾Œã€Enterã‚­ãƒ¼ã‚’2å›æŠ¼ã—ã¦ãƒã‚§ãƒƒã‚¯ã‚’é–‹å§‹ã—ã¾ã™ã€‚")
    print("3. æ¯”è¼ƒãƒ¢ãƒ¼ãƒ‰ã§ã¯ã€äºŒå›ã®å…¥åŠ›ãŒè¦æ±‚ã•ã‚Œã¾ã™ã€‚")
    print("4. çµ‚äº†ã™ã‚‹ã«ã¯ã€ä½•ã‚‚å…¥åŠ›ã›ãšã«Enterã‚­ãƒ¼ã‚’æŠ¼ã™ã‹ã€ã€Œexitã€ã¨å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚")
    print("-" * 45)
    
    # æ“ä½œãƒ¢ãƒ¼ãƒ‰ã®é¸æŠ
    print("æ“ä½œãƒ¢ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„ï¼š")
    print("1. å˜ä¸€å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰ï¼ˆé‡è¤‡ãƒã‚§ãƒƒã‚¯ã®ã¿ï¼‰")
    print("2. æ¯”è¼ƒãƒ¢ãƒ¼ãƒ‰ï¼ˆäºŒã¤ã®å…¥åŠ›ã‚’æ¯”è¼ƒï¼‰")
    
    while True:
        mode_input = input("ãƒ¢ãƒ¼ãƒ‰ã‚’é¸æŠ (1 ã¾ãŸã¯ 2): ").strip()
        if mode_input == '1':
            single_input_mode()
            break
        elif mode_input == '2':
            comparison_mode()
            break
        elif mode_input.lower() in ['exit', 'quit', 'q']:
            print("\nã”åˆ©ç”¨ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’çµ‚äº†ã—ã¾ã™ã€‚")
            return
        else:
            print("ç„¡åŠ¹ãªé¸æŠã§ã™ã€‚1 ã¾ãŸã¯ 2 ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚")

def single_input_mode():
    """
    å˜ä¸€å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰ï¼šå¾“æ¥ã®é‡è¤‡ãƒã‚§ãƒƒã‚¯æ©Ÿèƒ½
    """
    print("\n=== å˜ä¸€å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰ ===")
    print("-" * 45)

    while True:
        try:
            print("ãƒã‚§ãƒƒã‚¯ã—ãŸã„ãƒ†ã‚­ã‚¹ãƒˆã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ (è²¼ã‚Šä»˜ã‘å¾Œã€Enterã‚’2å›æŠ¼ã—ã¦å…¥åŠ›ã‚’ç¢ºå®šã—ã¾ã™):")
            # ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¤‡æ•°è¡Œã®ãƒ†ã‚­ã‚¹ãƒˆã‚’è²¼ã‚Šä»˜ã‘ã‚‰ã‚Œã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚
            lines = []
            while True:
                line = input()
                if not line:
                    break
                lines.append(line)
            user_input = "\n".join(lines)

            if user_input.lower() in ['exit', 'quit', 'q', '']:
                print("\nã”åˆ©ç”¨ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’çµ‚äº†ã—ã¾ã™ã€‚")
                break

            # æŠ½å‡ºã¨ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚
            overlaps, valids, invalids = extract_and_check_ips(user_input)

            print("-" * 45)
            # 1. ç„¡è¦–ã•ã‚ŒãŸç„¡åŠ¹ãªIPã«ã¤ã„ã¦å ±å‘Šã—ã¾ã™ã€‚
            if invalids:
                print(f"ğŸŸ¡ ä»¥ä¸‹ã®{len(invalids)}å€‹ã®ç„¡åŠ¹ãªIPã¯ç„¡è¦–ã•ã‚Œã¾ã—ãŸï¼š")
                for item in invalids:
                    print(f"  - {item}")
            
            # 2. æœ‰åŠ¹ãªIPã®ãƒã‚§ãƒƒã‚¯çµæœã‚’å ±å‘Šã—ã¾ã™ã€‚
            if not valids:
                 print("âŒ å…¥åŠ›ã‹ã‚‰æœ‰åŠ¹ãªIPã‚¢ãƒ‰ãƒ¬ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚")
            else:
                print(f"â„¹ï¸ {len(valids)}å€‹ã®æœ‰åŠ¹ãªIPç¯„å›²ã®æŠ½å‡ºã¨åˆ†æã«æˆåŠŸã—ã¾ã—ãŸã€‚")
                if not overlaps:
                    print("âœ… æœ‰åŠ¹ãªIPç¯„å›²å†…ã§é‡è¤‡ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚")
                else:
                    print(f"âš ï¸ è­¦å‘Šï¼{len(overlaps)}å€‹ã®é‡è¤‡ã™ã‚‹IPç¯„å›²ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸï¼š")
                    for i, pair in enumerate(overlaps, 1):
                        print(f"  {i}. {str(pair[0])} ã¨ {str(pair[1])} ãŒé‡è¤‡ã—ã¦ã„ã¾ã™")

            print("-" * 45 + "\n")

        except KeyboardInterrupt:
            # Ctrl+C ãŒæŠ¼ã•ã‚ŒãŸå ´åˆã®å‡¦ç†
            print("\n\nå‡¦ç†ãŒä¸­æ–­ã•ã‚Œã¾ã—ãŸã€‚ã”åˆ©ç”¨ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’çµ‚äº†ã—ã¾ã™ã€‚")
            break

def comparison_mode():
    """
    æ¯”è¼ƒãƒ¢ãƒ¼ãƒ‰ï¼šäºŒã¤ã®å…¥åŠ›ã‚’æ¯”è¼ƒ
    """
    print("\n=== æ¯”è¼ƒãƒ¢ãƒ¼ãƒ‰ ===")
    print("äºŒã¤ã®IPè¨­å®šã‚’å…¥åŠ›ã—ã¦æ¯”è¼ƒã—ã¾ã™ã€‚")
    print("-" * 45)

    while True:
        try:
            # æœ€åˆã®å…¥åŠ›
            print("ã€æœ€åˆã®å…¥åŠ›ã€‘IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å«ã‚€ãƒ†ã‚­ã‚¹ãƒˆã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„:")
            print("(è²¼ã‚Šä»˜ã‘å¾Œã€Enterã‚’2å›æŠ¼ã—ã¦å…¥åŠ›ã‚’ç¢ºå®šã—ã¾ã™)")
            lines1 = []
            while True:
                line = input()
                if not line:
                    break
                lines1.append(line)
            input1 = "\n".join(lines1)

            if input1.lower() in ['exit', 'quit', 'q', '']:
                print("\nã”åˆ©ç”¨ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’çµ‚äº†ã—ã¾ã™ã€‚")
                break

            # äºŒç•ªç›®ã®å…¥åŠ›
            print("\nã€äºŒç•ªç›®ã®å…¥åŠ›ã€‘æ¯”è¼ƒã—ãŸã„IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å«ã‚€ãƒ†ã‚­ã‚¹ãƒˆã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„:")
            print("(è²¼ã‚Šä»˜ã‘å¾Œã€Enterã‚’2å›æŠ¼ã—ã¦å…¥åŠ›ã‚’ç¢ºå®šã—ã¾ã™)")
            lines2 = []
            while True:
                line = input()
                if not line:
                    break
                lines2.append(line)
            input2 = "\n".join(lines2)

            if input2.lower() in ['exit', 'quit', 'q', '']:
                print("\nã”åˆ©ç”¨ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’çµ‚äº†ã—ã¾ã™ã€‚")
                break

            # ä¸¡æ–¹ã®å…¥åŠ›ã‚’è§£æ
            overlaps1, valids1, invalids1 = extract_and_check_ips(input1)
            overlaps2, valids2, invalids2 = extract_and_check_ips(input2)

            print("=" * 45)
            print("             è§£æçµæœ")
            print("=" * 45)

            # æœ€åˆã®å…¥åŠ›ã®çµæœ
            print("ã€æœ€åˆã®å…¥åŠ›ã®è§£æçµæœã€‘")
            if invalids1:
                print(f"ğŸŸ¡ {len(invalids1)}å€‹ã®ç„¡åŠ¹ãªIPã¯ç„¡è¦–ã•ã‚Œã¾ã—ãŸï¼š{', '.join(invalids1)}")
            if not valids1:
                print("âŒ æœ‰åŠ¹ãªIPã‚¢ãƒ‰ãƒ¬ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚")
            else:
                print(f"â„¹ï¸ {len(valids1)}å€‹ã®æœ‰åŠ¹ãªIPç¯„å›²ã‚’æ¤œå‡ºã—ã¾ã—ãŸã€‚")
                if overlaps1:
                    print(f"âš ï¸ {len(overlaps1)}å€‹ã®é‡è¤‡ã™ã‚‹IPç¯„å›²ãŒã‚ã‚Šã¾ã™ã€‚")

            print()

            # äºŒç•ªç›®ã®å…¥åŠ›ã®çµæœ
            print("ã€äºŒç•ªç›®ã®å…¥åŠ›ã®è§£æçµæœã€‘")
            if invalids2:
                print(f"ğŸŸ¡ {len(invalids2)}å€‹ã®ç„¡åŠ¹ãªIPã¯ç„¡è¦–ã•ã‚Œã¾ã—ãŸï¼š{', '.join(invalids2)}")
            if not valids2:
                print("âŒ æœ‰åŠ¹ãªIPã‚¢ãƒ‰ãƒ¬ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚")
            else:
                print(f"â„¹ï¸ {len(valids2)}å€‹ã®æœ‰åŠ¹ãªIPç¯„å›²ã‚’æ¤œå‡ºã—ã¾ã—ãŸã€‚")
                if overlaps2:
                    print(f"âš ï¸ {len(overlaps2)}å€‹ã®é‡è¤‡ã™ã‚‹IPç¯„å›²ãŒã‚ã‚Šã¾ã™ã€‚")

            print()

            # æ¯”è¼ƒçµæœ
            if valids1 or valids2:
                comparison = compare_ip_sets(valids1, valids2)
                print("ã€æ¯”è¼ƒçµæœã€‘")
                if comparison['identical']:
                    print("âœ… äºŒã¤ã®å…¥åŠ›ã®IPã‚¢ãƒ‰ãƒ¬ã‚¹è¨­å®šã¯å®Œå…¨ã«ä¸€è‡´ã—ã¦ã„ã¾ã™ï¼")
                else:
                    print("âš ï¸ äºŒã¤ã®å…¥åŠ›ã®IPã‚¢ãƒ‰ãƒ¬ã‚¹è¨­å®šã«é•ã„ãŒã‚ã‚Šã¾ã™ï¼š")
                    
                    if comparison['common']:
                        print(f"  ğŸ“Š å…±é€šã®IPç¯„å›² ({len(comparison['common'])}å€‹):")
                        for ip in comparison['common']:
                            print(f"    - {ip}")
                    
                    if comparison['only_in_first']:
                        print(f"  ğŸ”´ æœ€åˆã®å…¥åŠ›ã«ã®ã¿å­˜åœ¨ ({len(comparison['only_in_first'])}å€‹):")
                        for ip in comparison['only_in_first']:
                            print(f"    - {ip}")
                    
                    if comparison['only_in_second']:
                        print(f"  ğŸ”µ äºŒç•ªç›®ã®å…¥åŠ›ã«ã®ã¿å­˜åœ¨ ({len(comparison['only_in_second'])}å€‹):")
                        for ip in comparison['only_in_second']:
                            print(f"    - {ip}")
                
                print(f"  ğŸ“ˆ çµ±è¨ˆ: æœ€åˆ={comparison['total_first']}å€‹, äºŒç•ªç›®={comparison['total_second']}å€‹")

            print("-" * 45 + "\n")

        except KeyboardInterrupt:
            # Ctrl+C ãŒæŠ¼ã•ã‚ŒãŸå ´åˆã®å‡¦ç†
            print("\n\nå‡¦ç†ãŒä¸­æ–­ã•ã‚Œã¾ã—ãŸã€‚ã”åˆ©ç”¨ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’çµ‚äº†ã—ã¾ã™ã€‚")
            break

if __name__ == "__main__":
    main()
